name: Validate Skill

on:
  pull_request:
    paths:
      - 'SKILL.md'
      - 'references/**'
      - 'scripts/**'

jobs:
  validate:
    name: Validate SKILL.md
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4

      - name: Check SKILL.md exists
        run: test -f SKILL.md

      - name: Validate frontmatter
        run: |
          # Extract and validate YAML frontmatter
          python3 -c "
          import yaml, sys
          with open('SKILL.md') as f:
              content = f.read()
          if not content.startswith('---'):
              print('ERROR: SKILL.md must start with YAML frontmatter (---)')
              sys.exit(1)
          parts = content.split('---', 2)
          if len(parts) < 3:
              print('ERROR: Missing closing --- for frontmatter')
              sys.exit(1)
          meta = yaml.safe_load(parts[1])
          assert 'name' in meta, 'Missing required field: name'
          assert 'description' in meta, 'Missing required field: description'
          assert len(meta['name']) <= 64, f'name too long ({len(meta[\"name\"])} > 64)'
          assert len(meta['description']) <= 1024, f'description too long ({len(meta[\"description\"])} > 1024)'
          assert meta['name'] == meta['name'].lower(), 'name must be lowercase'
          assert '--' not in meta['name'], 'name must not contain consecutive hyphens'
          print(f'✅ Valid: {meta[\"name\"]} — {meta[\"description\"][:80]}...')
          "

      - name: Check references exist
        run: |
          # Verify all referenced files in SKILL.md exist
          grep -oP 'references/\S+\.md' SKILL.md | while read ref; do
            if [ ! -f "$ref" ]; then
              echo "ERROR: Referenced file $ref does not exist"
              exit 1
            fi
            echo "✅ $ref exists"
          done

      - name: Check scripts are executable
        run: |
          for script in scripts/*; do
            if [ -f "$script" ]; then
              if [ ! -x "$script" ]; then
                echo "WARNING: $script is not executable"
              fi
              # Basic syntax check for shell scripts
              if [[ "$script" == *.sh ]]; then
                bash -n "$script" && echo "✅ $script syntax OK" || exit 1
              fi
            fi
          done

      - name: Validate skill with npx skills (optional)
        continue-on-error: true
        run: |
          npx skills validate . 2>&1 || echo "⚠️ skills CLI validation not available (non-blocking)"
